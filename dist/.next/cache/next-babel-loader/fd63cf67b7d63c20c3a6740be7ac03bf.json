{"ast":null,"code":"import _regeneratorRuntime from \"@babel/runtime/regenerator\";\nimport _asyncToGenerator from \"@babel/runtime/helpers/esm/asyncToGenerator\";\nimport _classCallCheck from \"@babel/runtime/helpers/esm/classCallCheck\";\nimport _createClass from \"@babel/runtime/helpers/esm/createClass\";\nimport _assertThisInitialized from \"@babel/runtime/helpers/esm/assertThisInitialized\";\nimport _inherits from \"@babel/runtime/helpers/esm/inherits\";\nimport _possibleConstructorReturn from \"@babel/runtime/helpers/esm/possibleConstructorReturn\";\nimport _getPrototypeOf from \"@babel/runtime/helpers/esm/getPrototypeOf\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nvar __jsx = React.createElement;\n\nfunction _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = _getPrototypeOf(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = _getPrototypeOf(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return _possibleConstructorReturn(this, result); }; }\n\nfunction _isNativeReflectConstruct() { if (typeof Reflect === \"undefined\" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === \"function\") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }\n\n/* eslint-disable no-return-assign */\nimport { Button, message, Alert } from 'antd';\nimport { HourglassOutlined, ClockCircleOutlined, DownloadOutlined } from '@ant-design/icons';\nimport Head from 'next/head';\nimport React, { PureComponent } from 'react';\nimport './index.less';\nimport { updateCurrentUserBalance } from '@redux/user/actions';\nimport { videoService, purchaseItemService } from 'src/services';\nimport { connect } from 'react-redux';\nimport Popup from 'src/components/common/base/popup';\nimport { capitalizeFirstLetter, getResponseError, formatDate, formatDuration } from 'src/lib';\nimport nextCookie from 'next-cookies';\nimport Error from 'pages/_error';\nimport Loader from '@components/common/base/loader';\nimport NumberFormat from '@components/common/layout/numberformat';\nimport Router from 'next/router';\nimport ProfileCard from '@components/performer/profile-card';\n\nvar VideoDetailPage = /*#__PURE__*/function (_PureComponent) {\n  _inherits(VideoDetailPage, _PureComponent);\n\n  var _super = _createSuper(VideoDetailPage);\n\n  function VideoDetailPage(props) {\n    var _this;\n\n    _classCallCheck(this, VideoDetailPage);\n\n    _this = _super.call(this, props);\n\n    _defineProperty(_assertThisInitialized(_this), \"popupRef\", void 0);\n\n    _this.state = {\n      video: null,\n      loading: true,\n      success: false\n    };\n    return _this;\n  }\n\n  _createClass(VideoDetailPage, [{\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var _this$props = this.props,\n          data = _this$props.data,\n          isBrowser = _this$props.isBrowser;\n      isBrowser ? this.getVideoDetail() : this.setState({\n        video: data,\n        success: true,\n        loading: false\n      });\n    }\n  }, {\n    key: \"onOk\",\n    value: function () {\n      var _onOk = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var _this$props2, currentUser, data, dispatchUpdateCurrentUserBalance, value;\n\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                _this$props2 = this.props, currentUser = _this$props2.currentUser, data = _this$props2.data, dispatchUpdateCurrentUserBalance = _this$props2.updateCurrentUserBalance;\n                _context.prev = 1;\n\n                if (!(!currentUser || !currentUser._id)) {\n                  _context.next = 5;\n                  break;\n                }\n\n                message.error('Please login to buy this video!');\n                return _context.abrupt(\"return\", Router.push('/auth/login'));\n\n              case 5:\n                _context.next = 7;\n                return purchaseItemService.purchaseVideo(data._id);\n\n              case 7:\n                this.popupRef && this.popupRef.setVisible(false);\n                this.getVideoDetail();\n                value = -1 * data.token;\n                dispatchUpdateCurrentUserBalance(value);\n                _context.next = 16;\n                break;\n\n              case 13:\n                _context.prev = 13;\n                _context.t0 = _context[\"catch\"](1);\n                this.responseError(_context.t0);\n\n              case 16:\n                return _context.abrupt(\"return\", undefined);\n\n              case 17:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this, [[1, 13]]);\n      }));\n\n      function onOk() {\n        return _onOk.apply(this, arguments);\n      }\n\n      return onOk;\n    }()\n  }, {\n    key: \"getVideoDetail\",\n    value: function () {\n      var _getVideoDetail = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        var data, resp;\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                data = this.props.data;\n                this.setState({\n                  success: false,\n                  loading: true\n                });\n                _context2.prev = 2;\n                _context2.next = 5;\n                return videoService.userFindVideoById(data._id);\n\n              case 5:\n                resp = _context2.sent;\n                this.setState({\n                  video: resp.data,\n                  success: true\n                });\n                _context2.next = 12;\n                break;\n\n              case 9:\n                _context2.prev = 9;\n                _context2.t0 = _context2[\"catch\"](2);\n                this.responseError(_context2.t0);\n\n              case 12:\n                _context2.prev = 12;\n                this.setState({\n                  loading: false\n                });\n                return _context2.finish(12);\n\n              case 15:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this, [[2, 9, 12, 15]]);\n      }));\n\n      function getVideoDetail() {\n        return _getVideoDetail.apply(this, arguments);\n      }\n\n      return getVideoDetail;\n    }()\n  }, {\n    key: \"purchase\",\n    value: function purchase() {\n      var loggedIn = this.props.loggedIn;\n      if (!loggedIn) return message.error('Please login to buy this video!');\n      this.popupRef && this.popupRef.setVisible(true);\n      return undefined;\n    }\n  }, {\n    key: \"download\",\n    value: function download() {\n      var video = this.state.video;\n      if (!video) return;\n\n      if (video.isBought || !video.isSaleVideo) {\n        var e = document.createElement('a');\n        e.href = video.video.url;\n        e.target = '_blank';\n        document.body.appendChild(e);\n        e.click();\n      }\n    }\n  }, {\n    key: \"responseError\",\n    value: function () {\n      var _responseError = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(e) {\n        var err;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                _context3.next = 2;\n                return Promise.resolve(e);\n\n              case 2:\n                err = _context3.sent;\n                message.error(getResponseError(err));\n\n              case 4:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3);\n      }));\n\n      function responseError(_x) {\n        return _responseError.apply(this, arguments);\n      }\n\n      return responseError;\n    }()\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _data$video,\n          _this2 = this,\n          _video$video,\n          _video$video2;\n\n      var _this$state = this.state,\n          video = _this$state.video,\n          success = _this$state.success,\n          loading = _this$state.loading;\n      var _this$props3 = this.props,\n          data = _this$props3.data,\n          ui = _this$props3.ui,\n          loggedIn = _this$props3.loggedIn;\n      if (!data) return __jsx(Error, {\n        statusCode: 404\n      });\n      var dataSource = [{\n        title: 'Posted by:',\n        description: data.performer.username\n      }, {\n        title: 'Added on:',\n        description: formatDate(data.createdAt)\n      }, {\n        title: 'Duration:',\n        description: formatDuration((_data$video = data.video) === null || _data$video === void 0 ? void 0 : _data$video.duration)\n      }];\n      var performer = data === null || data === void 0 ? void 0 : data.performer;\n      data.isSaleVideo && dataSource.push({\n        title: 'Price: ',\n        description: __jsx(NumberFormat, {\n          value: data.token,\n          suffix: \" Tokens\"\n        })\n      });\n      return __jsx(React.Fragment, null, __jsx(Head, null, __jsx(\"title\", null, video && video.title ? video.title : 'Video'), __jsx(\"meta\", {\n        name: \"keywords\",\n        content: video && video.description\n      }), __jsx(\"meta\", {\n        name: \"description\",\n        content: video && video.description\n      }), __jsx(\"meta\", {\n        property: \"og:title\",\n        content: \"\".concat(ui === null || ui === void 0 ? void 0 : ui.siteName, \" | \").concat((video === null || video === void 0 ? void 0 : video.title) || 'Video'),\n        key: \"title\"\n      }), __jsx(\"meta\", {\n        property: \"og:image\",\n        content: video && video.thumbnail\n      }), __jsx(\"meta\", {\n        property: \"og:keywords\",\n        content: video && video.description\n      }), __jsx(\"meta\", {\n        property: \"og:description\",\n        content: video && video.description\n      })), __jsx(React.Fragment, null, __jsx(Popup, {\n        ref: function ref(_ref) {\n          return _this2.popupRef = _ref;\n        },\n        title: \"Buy Video \".concat(data === null || data === void 0 ? void 0 : data.title),\n        content: __jsx(\"div\", null, __jsx(\"strong\", null, \"Available high quality Video\"), __jsx(\"h3\", null, __jsx(NumberFormat, {\n          value: data.token,\n          prefix: \"Buy \".concat(capitalizeFirstLetter((data === null || data === void 0 ? void 0 : data.title) || ''), \" For \"),\n          suffix: \" Tokens\"\n        }))),\n        onOk: this.onOk.bind(this)\n      }), __jsx(\"div\", {\n        className: \"video-detail-page\"\n      }, !loading && success ? __jsx(React.Fragment, null, __jsx(\"div\", {\n        className: \"video-header\"\n      }, __jsx(\"div\", {\n        className: \"vid-title\"\n      }, video === null || video === void 0 ? void 0 : video.title), __jsx(\"div\", {\n        className: \"vid-duration\"\n      }, __jsx(HourglassOutlined, null), \"\\xA0\", formatDuration((video === null || video === void 0 ? void 0 : (_video$video = video.video) === null || _video$video === void 0 ? void 0 : _video$video.duration) || 0)), __jsx(\"div\", {\n        className: \"vid-duration\"\n      }, __jsx(ClockCircleOutlined, null), \"\\xA0\", formatDate(video === null || video === void 0 ? void 0 : video.createdAt))), __jsx(\"div\", {\n        className: \"video-player\"\n      }, (!video.isSaleVideo || video.isBought) && __jsx(\"video\", {\n        src: video === null || video === void 0 ? void 0 : (_video$video2 = video.video) === null || _video$video2 === void 0 ? void 0 : _video$video2.url,\n        controls: true,\n        poster: video === null || video === void 0 ? void 0 : video.thumbnail\n      }), video.isSaleVideo && !video.isBought && video.trailer && __jsx(React.Fragment, null, __jsx(\"video\", {\n        src: video === null || video === void 0 ? void 0 : video.trailer.url,\n        controls: true,\n        poster: video === null || video === void 0 ? void 0 : video.thumbnail\n      }), __jsx(\"p\", {\n        style: {\n          margin: '10px',\n          textAlign: 'center'\n        }\n      }, \"You're watching teaser video\")), video.isSaleVideo && !video.isBought && !video.trailer && __jsx(\"img\", {\n        src: video === null || video === void 0 ? void 0 : video.thumbnail,\n        alt: \"\"\n      })), __jsx(\"div\", {\n        className: \"video-stats\"\n      }, (video === null || video === void 0 ? void 0 : video.isSaleVideo) && !video.isBought && __jsx(Button, {\n        type: \"primary\",\n        htmlType: \"button\",\n        onClick: this.purchase.bind(this)\n      }, \"Buy Video\"), (loggedIn && (video === null || video === void 0 ? void 0 : video.isBought) || loggedIn && !(video !== null && video !== void 0 && video.isSaleVideo)) && __jsx(Button, {\n        type: \"dashed\",\n        htmlType: \"button\",\n        onClick: this.download.bind(this)\n      }, __jsx(DownloadOutlined, null), ' ', \"Download\")), (video === null || video === void 0 ? void 0 : video.isSaleVideo) && !(video !== null && video !== void 0 && video.isBought) && __jsx(\"div\", {\n        style: {\n          margin: '10px 0'\n        }\n      }, __jsx(Alert, {\n        message: \"To view full content, please buy this video!\",\n        type: \"error\"\n      })), __jsx(\"div\", {\n        className: \"video-info\"\n      }, __jsx(\"div\", {\n        className: \"video-description\"\n      }, (video === null || video === void 0 ? void 0 : video.description) || 'No video description')), performer && __jsx(ProfileCard, {\n        placeholderAvatarUrl: ui === null || ui === void 0 ? void 0 : ui.placeholderAvatarUrl,\n        performer: performer,\n        searching: loading,\n        success: success\n      })) : __jsx(React.Fragment, null, __jsx(Loader, {\n        spinning: true\n      })))));\n    }\n  }], [{\n    key: \"getInitialProps\",\n    value: function () {\n      var _getInitialProps = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4(_ref2) {\n        var ctx, query, _nextCookie, token, headers, resp;\n\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                ctx = _ref2.ctx;\n                _context4.prev = 1;\n                query = ctx.query;\n\n                if (!query.data) {\n                  _context4.next = 5;\n                  break;\n                }\n\n                return _context4.abrupt(\"return\", {\n                  data: JSON.parse(query.data),\n                  isBrowser: true\n                });\n\n              case 5:\n                if (!query.id) {\n                  _context4.next = 12;\n                  break;\n                }\n\n                _nextCookie = nextCookie(ctx), token = _nextCookie.token;\n                headers = {\n                  Authorization: token\n                };\n                _context4.next = 10;\n                return videoService.userFindVideoById(query.id, headers);\n\n              case 10:\n                resp = _context4.sent;\n                return _context4.abrupt(\"return\", {\n                  data: resp.data,\n                  isBrowser: true\n                });\n\n              case 12:\n                _context4.next = 17;\n                break;\n\n              case 14:\n                _context4.prev = 14;\n                _context4.t0 = _context4[\"catch\"](1);\n                return _context4.abrupt(\"return\", {});\n\n              case 17:\n                return _context4.abrupt(\"return\", {});\n\n              case 18:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, null, [[1, 14]]);\n      }));\n\n      function getInitialProps(_x2) {\n        return _getInitialProps.apply(this, arguments);\n      }\n\n      return getInitialProps;\n    }()\n  }]);\n\n  return VideoDetailPage;\n}(PureComponent);\n\n_defineProperty(VideoDetailPage, \"authenticate\", false);\n\n_defineProperty(VideoDetailPage, \"layout\", 'public');\n\nvar mapStates = function mapStates(state) {\n  return {\n    ui: state.ui,\n    loggedIn: state.auth.loggedIn,\n    currentUser: state.user.current,\n    currentPerformer: state.performer.current\n  };\n};\n\nvar mapDispatchs = {\n  updateCurrentUserBalance: updateCurrentUserBalance\n};\nexport default connect(mapStates, mapDispatchs)(VideoDetailPage);","map":null,"metadata":{},"sourceType":"module"}